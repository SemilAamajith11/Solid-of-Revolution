<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Solid of Revolution — v2.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">

  <!-- Plotly for 2D/3D plots -->
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

  <!-- Math.js for parsing/evaluating functions -->
  <script src="https://cdn.jsdelivr.net/npm/mathjs@11.11.1/lib/browser/math.js"></script>

  <!-- MathJax for pretty math (optional but nice) -->
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    :root{
      --bg: #0b0f19;
      --panel: #0e1425;
      --panel-2: #0c1222;
      --text: #e6ebf5;
      --muted: #a8b3cf;
      --accent: #64d2ff;
      --accent-2: #c778ff;
      --accent-3: #7ef29a;
      --danger: #ff6b6b;
      --grid: #202a44;
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --radius: 14px;
    }
    *{box-sizing: border-box}
    html, body { height: 100% }
    body{
      margin: 0;
      background: radial-gradient(1200px 800px at 20% -10%, #121a33 0%, #0b0f19 50%) no-repeat, var(--bg);
      color: var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      letter-spacing: 0.1px;
    }

    header{
      padding: 22px 24px 10px 24px;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    header .brand{
      display:flex; align-items:center; gap:12px;
    }
    .logo{
      width: 38px; height: 38px; border-radius: 12px;
      background: conic-gradient(from 220deg at 50% 50%, var(--accent), var(--accent-2), var(--accent-3), var(--accent));
      filter: saturate(120%) brightness(0.95);
      box-shadow: inset 0 0 20px rgba(255,255,255,0.12), 0 8px 30px rgba(100,210,255,0.18);
    }
    h1{
      font-size: 20px; margin:0; font-weight:700; letter-spacing:0.3px;
    }
    .subtitle{
      color: var(--muted); font-size: 13px; margin-top: 2px;
      font-family: "JetBrains Mono", ui-monospace, monospace;
    }

    .container{
      display: grid;
      grid-template-columns: 360px 1fr;
      gap: 18px;
      padding: 10px 20px 22px 20px;
    }
    @media (max-width: 1024px){
      .container{ grid-template-columns: 1fr; }
    }

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent), var(--panel);
      border: 1px solid #101938;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .panel-header{
      padding: 16px 16px 8px 16px; border-bottom: 1px solid #121b3a;
      display:flex; align-items:center; justify-content:space-between;
    }
    .panel-title{ font-weight: 700; letter-spacing: 0.25px; }
    .panel-body{ padding: 14px 16px 16px 16px; }

    .controls{
      display:grid; gap: 14px;
    }
    .row{
      display: grid; gap: 12px;
    }
    .row.two{
      grid-template-columns: 1fr 1fr;
    }
    label{ font-size: 13px; color: var(--muted); margin-bottom: 6px; display:block; }
    select, input[type="text"], input[type="number"]{
      width: 100%;
      background: var(--panel-2); color: var(--text);
      border: 1px solid #172146; border-radius: 12px;
      font-size: 14px;
      padding: 10px 12px;
      outline: none;
      transition: border-color .2s, box-shadow .2s, transform .05s;
      font-family: "JetBrains Mono", ui-monospace, monospace;
    }
    select:focus, input:focus{
      border-color: #2449ff8a;
      box-shadow: 0 0 0 6px rgba(46,120,255,0.12);
    }
    .hint{
      font-size: 12px; color: var(--muted);
      margin-top: 6px;
      font-family: "JetBrains Mono", ui-monospace, monospace;
    }

    .axis-options{
      display:flex; gap: 10px; flex-wrap:wrap;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px; padding:8px 12px;
      background: #0f1936; border: 1px solid #172146; border-radius: 999px;
      cursor: pointer; user-select: none;
      transition: all .2s;
    }
    .chip input{ display:none }
    .chip.active{
      background: linear-gradient(180deg, rgba(100,210,255,0.1), rgba(199,120,255,0.05));
      border-color: #2b4fb9;
      box-shadow: inset 0 0 0 1px rgba(100,210,255,0.12);
    }

    .btns{ display:flex; gap: 10px; flex-wrap: wrap; margin-top: 6px; }
    button{
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border: 1px solid #1a2450; color: var(--text);
      border-radius: 12px; padding: 10px 14px; font-weight:600;
      cursor: pointer; transition: transform .06s ease, box-shadow .2s, border-color .2s;
    }
    button:hover{ border-color: #2b4fb9; box-shadow: 0 8px 24px rgba(32,64,190,0.2);}
    button:active{ transform: translateY(1px) scale(0.995); }
    .btn-primary{
      background: linear-gradient(180deg, rgba(100,210,255,0.16), rgba(199,120,255,0.1));
      border-color: #2b4fb9;
    }
    .btn-ghost{ background: transparent; }
    .btn-danger{ border-color: #442027; background: linear-gradient(180deg, rgba(255,107,107,0.12), rgba(255,107,107,0.06)); }

    .plots{
      display: grid; gap: 16px;
      grid-template-rows: 360px auto;
      padding: 12px;
    }

    #plot2d, #plot3d{ width: 100%; height: 100%; }

    .plot-panel{ position: relative; overflow: hidden; }
    .plot-panel .toolbar{
      position: absolute; top: 10px; right: 10px; display: flex; gap: 8px; z-index: 3;
    }
    .badge{
      background: #0f1936; border: 1px solid #172146; padding: 6px 10px; border-radius: 999px; font-size: 12px; color: var(--muted);
    }

    .volume-box{
      display:flex; align-items:center; justify-content:space-between; gap: 10px;
      padding: 12px 12px; margin-top:8px;
      border: 1px dashed #27325d; border-radius: 12px;
      background: linear-gradient(180deg, rgba(100,210,255,0.08), rgba(199,120,255,0.06));
    }
    .volume-value{ font-size: 18px; font-weight: 700; color: var(--accent-3); font-family: "JetBrains Mono", monospace; }
    .formula{ color: var(--muted); font-size: 13px; }

    .footer{
      margin: 14px 20px 24px; padding: 14px 16px;
      border: 1px solid #101938; border-radius: 12px; background: var(--panel);
      display:flex; flex-wrap:wrap; gap: 12px; align-items:center; justify-content: space-between;
    }
    .contact{ display:flex; gap: 10px; align-items:center; }
    .contact a{ color: var(--accent); text-decoration: none; }
    .clock{ color: var(--muted); font-family: "JetBrains Mono", monospace; }

    /* Loading overlay */
    .loader{
      position: fixed; inset: 0; z-index: 9999;
      background: radial-gradient(800px 500px at 20% 10%, #121a33 0%, #0b0f19 50%) no-repeat, var(--bg);
      display:flex; align-items:center; justify-content:center;
      flex-direction:column; gap: 18px;
      color: var(--text);
      transition: opacity .4s ease, visibility .4s ease;
    }
    .loader.hidden{ opacity: 0; visibility: hidden; }
    .spinner{
      width: 72px; height: 72px; border-radius: 50%;
      border: 6px solid rgba(100,210,255,0.15);
      border-top-color: var(--accent); border-right-color: var(--accent-2);
      animation: spin 1s linear infinite;
      box-shadow: 0 0 60px rgba(100,210,255,0.15), 0 0 40px rgba(199,120,255,0.12) inset;
    }
    @keyframes spin { to { transform: rotate(360deg) } }
    .loader .tip{
      font-family: "JetBrains Mono", monospace; font-size: 13px; color: var(--muted);
      opacity: 0.9;
    }

    /* Expandable 3D palette */
    .plot3d-container{
      position: relative; height: 460px;
      border: 1px solid #101938; border-radius: var(--radius);
      background: var(--panel);
      transition: all .35s ease;
    }
    .plot3d-container.expanded{
      position: fixed; inset: 12px; z-index: 50;
      border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.45);
      backdrop-filter: blur(2px);
    }
    .plot3d-container .actions{
      position: absolute; right: 10px; top: 10px; display:flex; gap: 8px; z-index: 5;
    }
    .muted{ color: var(--muted); }

    .error{
      margin-top: 8px; font-size: 13px; color: var(--danger);
      font-family: "JetBrains Mono", monospace;
    }

    /* Subtle glow on hover elements */
    .glow:hover{ box-shadow: 0 0 0 4px rgba(100,210,255,0.12); }

    /* Tiny helper grid for plot backgrounds via Plotly layout */
  </style>
</head>

<body>
  <!-- Loading overlay -->
  <div class="loader" id="loader">
    <div class="spinner"></div>
    <div class="tip">Loading…</div>
  </div>

  <header>
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>Solid of Revolution — Visualizer</h1>
        <div class="subtitle">Plot. Rotate. Understand. ✨</div>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- Controls -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Controls</div>
        <span class="badge">© 2025 Semila Amajith</span>
      </div>
      <div class="panel-body">
        <div class="controls">

          <div class="row">
            <label>Function f(x)</label>
            <select id="preset">
              <option value="x^2">x^2</option>
              <option value="sin(x)">sin(x)</option>
              <option value="cos(x)">cos(x)</option>
              <option value="exp(x)">e^x</option>
              <option value="abs(x)">|x|</option>
              <option value="sqrt(x)">sqrt(x)</option>
              <option value="1/x">1/x</option>
              <option value="custom">Custom…</option>
            </select>
            <input id="customFn" type="text" placeholder="Type custom expression, e.g. exp(-x^2) * cos(3x)" disabled />
            <div class="hint">sin, cos, tan, exp, log, sqrt, abs, ^ for power. Variable is x.</div>
          </div>

          <div class="row two">
            <div>
              <label>Lower limit a</label>
              <input id="a" type="number" step="any" value="0" />
            </div>
            <div>
              <label>Upper limit b</label>
              <input id="b" type="number" step="any" value="2" />
            </div>
          </div>

          <div class="row">
            <label>Axis of Revolution</label>
            <div class="axis-options">
              <label class="chip active" id="chip-x">
                <input type="radio" name="axis" value="x" checked />
                Around x-axis (y = 0)
              </label>
              <label class="chip" id="chip-y">
                <input type="radio" name="axis" value="y" />
                Around y-axis (x = 0)
              </label>
            </div>
          </div>

          <div class="row">
            <div class="btns">
              <button id="updateBtn" class="btn-primary glow">Update Plot</button>
              <button id="animateBtn" class="glow">Animate Rotation</button>
              <button id="toggle3DBtn" class="glow">Toggle 3D View</button>
              <button id="resetBtn" class="btn-ghost">Reset</button>
            </div>
            <div id="error" class="error" style="display:none;"></div>
          </div>

          <div class="row">
            <div class="volume-box">
              <div>
                <div class="formula" id="formula">(formula appears here)</div>
                <div class="hint">We use washers for x-axis and cylindrical shells for y-axis.</div>
              </div>
              <div class="volume-value" id="volumeValue">—</div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Plots -->
    <div class="panel plot-panel">
      <div class="panel-header">
        <div class="panel-title">Visualizations</div>
        <div class="toolbar">
          <span class="badge">Interactive</span>
        </div>
      </div>

      <div class="plots">
        <div id="plot2d" class="panel" style="height: 360px;"></div>

        <div class="plot3d-container" id="plot3dContainer">
          <div class="actions">
            <button id="expand3D" class="glow">Expand</button>
            <button id="hide3D" class="glow">Hide 3D</button>
          </div>
          <div id="plot3d" style="width:100%; height: 100%;"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">
    <div class="contact">
      <span class="muted">Contact:</span>
      <a href="mailto:semila.info@gmail.com">semila.info@gmail.com</a>
      <span class="muted">•</span>
      <a href="#" onclick="alert('Solid of Revolution- v2.0- A tool to visualize solids of revolution in 2D & 3D using modern web tech. © 2025 Semila Amajith');return false;">Semila Amajith</a>
    </div>
    <div class="clock" id="clock"></div>
  </div>

  <script>
    // --- State ---
    let compiled = null; // compiled math.js function
    let currentExpr = "x^2";
    let axis = "x"; // 'x' or 'y'
    let show3D = true;
    let animating = false;
    let phiMax = Math.PI * 2; // full rotation
    let lastCameraAngle = 0;
    const twoPi = Math.PI * 2;

    // --- Elements ---
    const el = (id) => document.getElementById(id);
    const presetSel = el('preset');
    const customFnInput = el('customFn');
    const aInput = el('a');
    const bInput = el('b');
    const chipX = el('chip-x'); const chipY = el('chip-y');
    const updateBtn = el('updateBtn');
    const animateBtn = el('animateBtn');
    const toggle3DBtn = el('toggle3DBtn');
    const expand3DBtn = el('expand3D');
    const hide3DBtn = el('hide3D');
    const plot3dContainer = el('plot3dContainer');
    const formulaEl = el('formula');
    const volumeValueEl = el('volumeValue');
    const errorEl = el('error');
    const loaderEl = el('loader');

    // --- Helpers ---
    function setError(msg){
      if (!msg){ errorEl.style.display='none'; errorEl.textContent=''; return; }
      errorEl.textContent = msg;
      errorEl.style.display = 'block';
    }

    function linspace(a, b, n){
      const arr = new Array(n);
      if (n === 1){ arr[0] = a; return arr; }
      const step = (b - a) / (n - 1);
      for (let i=0;i<n;i++) arr[i] = a + i*step;
      return arr;
    }

    function tryCompile(expr){
      try{
        const node = math.parse(expr);
        const code = node.compile();
        return function(x){
          const val = code.evaluate({x});
          if (!isFinite(val)) return NaN;
          return val;
        };
      }catch(e){
        return null;
      }
    }

    function sampleFunction(fn, a, b, n=400){
      const xs = linspace(a, b, n);
      const ys = xs.map(x => {
        try{
          const y = fn(x);
          return (isFinite(y) ? y : NaN);
        }catch(_){ return NaN; }
      });
      return {xs, ys};
    }

    // Composite Simpson's rule (requires nEven even)
    function integrateSimpson(fn, a, b, nEven=1000){
      if (nEven % 2 === 1) nEven++;
      const h = (b - a) / nEven;
      let sum = 0;
      let f0 = fn(a), fnB = fn(b);
      if (!isFinite(f0) || !isFinite(fnB)) return NaN;

      let oddSum = 0, evenSum = 0;
      for (let i=1; i<nEven; i++){
        const x = a + i*h;
        const fx = fn(x);
        if (!isFinite(fx)) return NaN;
        if (i % 2 === 1) oddSum += fx;
        else evenSum += fx;
      }
      sum = f0 + fnB + 4*oddSum + 2*evenSum;
      return sum * h / 3;
    }

    function formatNumber(num){
      if (!isFinite(num)) return "—";
      if (Math.abs(num) >= 1e5 || Math.abs(num) < 1e-3) return num.toExponential(6);
      return num.toLocaleString(undefined, {maximumFractionDigits: 6});
    }

    function updateAxisChips(){
      chipX.classList.toggle('active', axis === 'x');
      chipY.classList.toggle('active', axis === 'y');
    }

    // Plot 2D curve and area
    function draw2D(fn, a, b, axis){
      const n = 600;
      const xs = linspace(a, b, n);
      const ys = xs.map(x => {
        try{ return fn(x);}catch(_){ return NaN; }
      });

      // Basic sanity: if too many NaNs, warn.
      const invalid = ys.filter(y => !isFinite(y)).length;
      if (invalid > n * 0.05){
        setError("Function is not real-valued across the interval. Try changing a, b or the function.");
      }else{
        setError("");
      }

      // Build traces
      const curveTrace = {
        type: 'scatter',
        mode: 'lines',
        x: xs, y: ys,
        line: { color: '#8fb6ff', width: 2 },
        name: 'f(x)'
      };

      // Area highlight within [a,b] to axis (x-axis => tozeroy, y-axis => tozerox)
      const areaTrace = {
        type: 'scatter',
        mode: 'lines',
        x: xs, y: ys,
        line: { color: 'rgba(126,242,154,0.0)', width: 0.5 },
        fill: (axis === 'x') ? 'tozeroy' : 'tozerox',
        fillcolor: 'rgba(126,242,154,0.22)',
        name: 'Area (revolved)'
      };

      // Axis-of-revolution line
      const shapes = [];
      if (axis === 'x'){
        shapes.push({
          type: 'line', x0: a, x1: b, y0: 0, y1: 0,
          line: {color: '#c778ff', width: 2, dash: 'dot'}
        });
      }else{
        shapes.push({
          type: 'line', x0: 0, x1: 0, y0: Math.min(...ys.filter(isFinite), 0), y1: Math.max(...ys.filter(isFinite), 0),
          line: {color: '#c778ff', width: 2, dash: 'dot'}
        });
      }

      const layout = {
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        margin: {l: 50, r: 20, t: 20, b: 40},
        xaxis: {
          gridcolor: '#1c2340', zerolinecolor: '#2b3561',
          linecolor: '#2b3561', mirror: true,
          tickfont: {color: '#bcd0ff'}, title: 'x', titlefont: {color: '#bcd0ff'}
        },
        yaxis: {
          gridcolor: '#1c2340', zerolinecolor: '#2b3561',
          linecolor: '#2b3561', mirror: true,
          tickfont: {color: '#bcd0ff'}, title: 'y', titlefont: {color: '#bcd0ff'}
        },
        shapes,
        showlegend: false
      };

      Plotly.newPlot('plot2d', [curveTrace, areaTrace], layout, {displayModeBar: true, responsive: true});
    }

    // Build surface mesh for rotation about x-axis
    function surfaceAboutXAxis(fn, a, b, phiMax, nx=120, nPhi=80){
      const xs = linspace(a, b, nx);
      const phis = linspace(0, Math.max(phiMax, 1e-6), Math.max(3, Math.round(nPhi * (phiMax / (2*Math.PI) || 0.05))));
      const X = [], Y = [], Z = [];
      for (let i=0; i<xs.length; i++){
        const x = xs[i];
        let y;
        try{ y = fn(x); }catch(_){ y = NaN; }
        const r = Math.abs(y);
        const rowX = [], rowY = [], rowZ = [];
        for (let j=0; j<phis.length; j++){
          const t = phis[j];
          rowX.push(x);
          rowY.push(r * Math.cos(t));
          rowZ.push(r * Math.sin(t));
        }
        X.push(rowX); Y.push(rowY); Z.push(rowZ);
      }
      return {X, Y, Z};
    }

    // Build surface mesh for rotation about y-axis
    function surfaceAboutYAxis(fn, a, b, phiMax, nx=120, nPhi=80){
      const xs = linspace(a, b, nx);
      const phis = linspace(0, Math.max(phiMax, 1e-6), Math.max(3, Math.round(nPhi * (phiMax / (2*Math.PI) || 0.05))));
      const X = [], Y = [], Z = [];
      for (let i=0; i<xs.length; i++){
        const x = xs[i];
        let y;
        try{ y = fn(x); }catch(_){ y = NaN; }
        const r = Math.abs(x);
        const rowX = [], rowY = [], rowZ = [];
        for (let j=0; j<phis.length; j++){
          const t = phis[j];
          rowX.push(r * Math.cos(t));
          rowY.push(y);
          rowZ.push(r * Math.sin(t));
        }
        X.push(rowX); Y.push(rowY); Z.push(rowZ);
      }
      return {X, Y, Z};
    }

    function draw3D(fn, a, b, axis, phiMax){
      // Generate surface
      const mesh = axis === 'x' ? surfaceAboutXAxis(fn, a, b, phiMax) : surfaceAboutYAxis(fn, a, b, phiMax);

      const surface = {
        type: 'surface',
        x: mesh.X, y: mesh.Y, z: mesh.Z,
        colorscale: [
          [0, '#1b2d5b'],
          [0.25, '#2a4f9e'],
          [0.5, '#3b9ad9'],
          [0.75, '#62d0ff'],
          [1, '#c778ff']
        ],
        opacity: 0.95,
        showscale: false,
        lighting: {ambient: 0.6, diffuse: 0.9, roughness: 0.6, specular: 0.2}
      };

      const layout3d = {
        paper_bgcolor: 'rgba(0,0,0,0)',
        scene: {
          xaxis: {title: 'x', color: '#bcd0ff', gridcolor: '#1c2340', zerolinecolor: '#2b3561'},
          yaxis: {title: axis === 'x' ? 'y (rotated)' : 'y', color: '#bcd0ff', gridcolor: '#1c2340', zerolinecolor: '#2b3561'},
          zaxis: {title: 'z', color: '#bcd0ff', gridcolor: '#1c2340', zerolinecolor: '#2b3561'},
          bgcolor: '#0e1425',
          camera: {eye: {x: 1.6, y: 1.2, z: 1.4}}
        },
        margin: {l: 0, r: 0, t: 0, b: 0}
      };

      Plotly.newPlot('plot3d', [surface], layout3d, {displayModeBar: true, responsive: true});
    }

    function update3D(fn, a, b){
      if (!show3D) return;
      draw3D(fn, a, b, axis, phiMax);
    }

    function updateFormulaDisplay(){
      // Show the formula used for volume
      if (axis === 'x'){
        formulaEl.textContent = "V = π ∫[a→b] (f(x))^2 dx  (washers about x-axis)";
      } else {
        formulaEl.textContent = "V = 2π ∫[a→b] |x|·|f(x)| dx  (cylindrical shells about y-axis)";
      }
      if (window.MathJax && MathJax.typesetPromise){
        // Using text content; keeping simple. If you want TeX, you can wrap with KATEX_INLINE_OPEN KATEX_INLINE_CLOSE.
        MathJax.typesetPromise();
      }
    }

    function computeVolume(fn, a, b){
      if (a === b) return 0;
      if (a > b) [a, b] = [b, a];

      if (axis === 'x'){
        // V = π ∫ f(x)^2 dx
        const integral = integrateSimpson(x => {
          const y = fn(x);
          if (!isFinite(y)) return NaN;
          return y*y;
        }, a, b, 1000);
        return Math.PI * integral;
      } else {
        // V = 2π ∫ |x| |f(x)| dx
        const integral = integrateSimpson(x => {
          const y = fn(x);
          if (!isFinite(y)) return NaN;
          return Math.abs(x) * Math.abs(y);
        }, a, b, 1000);
        return 2 * Math.PI * integral;
      }
    }

    function updateAll(){
      // Compile function
      const expr = (presetSel.value === 'custom') ? customFnInput.value.trim() : presetSel.value;
      const fn = tryCompile(expr);
      if (!fn){
        setError("Could not parse function. Check your expression.");
        return;
      }
      compiled = fn;
      currentExpr = expr;

      // Limits
      let a = parseFloat(aInput.value);
      let b = parseFloat(bInput.value);
      if (!isFinite(a) || !isFinite(b)){
        setError("Please enter numeric limits a and b.");
        return;
      }
      if (a > b){ const t=a; a=b; b=t; aInput.value=a; bInput.value=b; }

      // 2D plot
      draw2D(compiled, a, b, axis);

      // Volume
      const V = computeVolume(compiled, a, b);
      if (!isFinite(V)){
        setError("Volume integral failed (function not real-valued on the interval).");
        volumeValueEl.textContent = "—";
      }else{
        setError("");
        volumeValueEl.textContent = formatNumber(V) + " (units³)";
      }

      // 3D
      updateFormulaDisplay();
      update3D(compiled, a, b);
    }

    // Animation
    let animReq = null;
    function animate(){
      if (!animating) return;
      phiMax += (Math.PI / 90); // grows the sweep
      if (phiMax > twoPi) phiMax = twoPi;

      // gentle camera orbit
      lastCameraAngle += 0.02;
      const R = 1.8;
      const eye = {x: R*Math.cos(lastCameraAngle), y: 1.1, z: R*Math.sin(lastCameraAngle)};
      Plotly.relayout('plot3d', {'scene.camera.eye': eye});

      // update surface
      const a = parseFloat(aInput.value), b = parseFloat(bInput.value);
      const mesh = (axis === 'x') ? surfaceAboutXAxis(compiled, a, b, phiMax) : surfaceAboutYAxis(compiled, a, b, phiMax);
      Plotly.restyle('plot3d', {x: [mesh.X], y: [mesh.Y], z: [mesh.Z]});

      if (phiMax < twoPi){
        animReq = requestAnimationFrame(animate);
      }else{
        // Done
        animating = false;
        animateBtn.textContent = "Animate Rotation";
      }
    }

    // --- Event wiring ---
    presetSel.addEventListener('change', () => {
      const isCustom = presetSel.value === 'custom';
      customFnInput.disabled = !isCustom;
      if (!isCustom){
        customFnInput.value = "";
      }
      updateAll();
    });
    customFnInput.addEventListener('change', updateAll);
    aInput.addEventListener('change', updateAll);
    bInput.addEventListener('change', updateAll);

    chipX.addEventListener('click', () => {
      axis = 'x'; updateAxisChips(); updateAll();
    });
    chipY.addEventListener('click', () => {
      axis = 'y'; updateAxisChips(); updateAll();
    });

    updateBtn.addEventListener('click', () => { phiMax = twoPi; animating = false; updateAll(); });

    animateBtn.addEventListener('click', () => {
      if (!show3D){ show3D = true; plot3dContainer.style.display = ''; }
      if (animating){
        animating = false; animateBtn.textContent = "Animate Rotation";
        if (animReq) cancelAnimationFrame(animReq);
      }else{
        phiMax = 0.0001; // start from 0
        animating = true; animateBtn.textContent = "Pause Animation";
        updateAll(); // draw starting sweep
        animReq = requestAnimationFrame(animate);
      }
    });

    toggle3DBtn.addEventListener('click', () => {
      show3D = !show3D;
      plot3dContainer.style.display = show3D ? '' : 'none';
      if (show3D) updateAll();
    });

    expand3DBtn.addEventListener('click', () => {
      const expanded = plot3dContainer.classList.toggle('expanded');
      expand3DBtn.textContent = expanded ? 'Collapse' : 'Expand';
      setTimeout(() => Plotly.Plots.resize('plot3d'), 350);
    });

    hide3DBtn.addEventListener('click', () => {
      show3D = false;
      plot3dContainer.style.display = 'none';
    });

    el('resetBtn').addEventListener('click', () => {
      presetSel.value = 'x^2';
      customFnInput.value = "";
      customFnInput.disabled = true;
      aInput.value = 0; bInput.value = 2;
      axis = 'x'; updateAxisChips();
      phiMax = twoPi; animating = false; animateBtn.textContent = "Animate Rotation";
      updateAll();
    });

    // Clock (device time)
    function updateClock(){
      const d = new Date();
      const str = d.toLocaleString(undefined, {
        weekday: 'short',
        year: 'numeric', month: 'short', day: 'numeric',
        hour: '2-digit', minute: '2-digit', second: '2-digit'
      });
      el('clock').textContent = 'Device time: ' + str;
    }
    setInterval(updateClock, 1000);

    // Initial
    window.addEventListener('load', () => {
      updateClock();
      updateAll();
      setTimeout(() => loaderEl.classList.add('hidden'), 400);
    });

    window.addEventListener('resize', () => {
      Plotly.Plots.resize('plot2d');
      if (show3D) Plotly.Plots.resize('plot3d');
    });
  </script>
</body>
</html>
